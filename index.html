<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Microscope Flow</title>
<style>
  :root{
    --panel:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.14);
    --hint-size:clamp(18px,3.6vw,28px);
    --cmd-size:clamp(18px,3.8vw,24px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:#fff;
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  body{
    background:
      radial-gradient(1100px 550px at 10% -10%, #60a5fa22, transparent 60%),
      radial-gradient(900px 450px at 110% 0%, #a78bfa22, transparent 60%),
      radial-gradient(600px 600px at 50% 120%, #22d3ee20, transparent 60%),
      linear-gradient(#0b1220,#0e172a 40%,#111827);
    overflow:hidden;
  }

  .screen{position:fixed; inset:0; display:none;}
  .screen.show{display:block;}
  .stage{position:absolute; inset:0; display:grid; place-items:center; padding:16px;}
  .frame{
    width:min(980px,96vw); aspect-ratio:16/9; border-radius:18px;
    border:1px solid var(--border); background:var(--panel); backdrop-filter:blur(6px);
    position:relative; overflow:hidden; display:grid; place-items:center; padding:16px;
  }

  /* 1画面目：顕微鏡画像（中央に大きく） */
  .scope-photo{
    max-width:92%; max-height:78%;
    object-fit:contain; display:block; margin:auto;
    filter:drop-shadow(0 8px 18px #0008);
  }

  /* 2画面目：丸い視野の中央に「画像１」 */
  .view-wrap{position:absolute; inset:0; display:grid; place-items:center;}
  .view{
    width:min(90vmin,820px); aspect-ratio:1/1; border-radius:50%;
    background:
      radial-gradient(circle at 50% 50%, #ffffff10 0 38%, #00000099 98%, #000 100%),
      radial-gradient(circle at 50% 50%, #142033 0 60%, #0e172a 100%);
    box-shadow:0 0 0 6px #000, 0 0 36px #00e3ff44, inset 0 0 80px #000;
    overflow:hidden; display:grid; place-items:center;
  }
  .view-img{width:100%; height:100%; object-fit:contain; display:block;}

  /* 下部テキスト＆コマンド（□かこみ） */
  .bottom{
    position:absolute; left:0; right:0; bottom:max(16px, env(safe-area-inset-bottom));
    display:grid; justify-items:center; gap:12px; padding:0 16px;
  }
  .hint{font-weight:800; font-size:var(--hint-size); text-shadow:0 2px 10px #0009}
  .cmd{
    font-weight:900; font-size:var(--cmd-size); letter-spacing:.03em;
    padding:.9em 1.4em; border:2px solid #fff; background:transparent; color:#fff;
    border-radius:14px; cursor:pointer; box-shadow:0 2px 14px #0006;
  }
  .cmd:active{transform:translateY(1px); opacity:.9}
</style>
</head>
<body>

<!-- 画面1：顕微鏡（中央に大きく） -->
<section id="s1" class="screen show">
  <div class="stage">
    <div class="frame">
      <img id="scope" class="scope-photo" alt="microscope">
      <div class="bottom">
        <div class="hint">顕微鏡に何かが見えるよ？</div>
        <button id="toView" class="cmd" type="button">顕微鏡をのぞいてみる</button>
      </div>
    </div>
  </div>
</section>

<!-- 画面2：視野の中央に「画像１」 -->
<section id="s2" class="screen">
  <div class="stage">
    <div class="frame">
      <div class="view-wrap">
        <div class="view" aria-label="顕微鏡の視野（カラー）">
          <img id="viewPic" class="view-img" alt="画像１">
        </div>
      </div>
      <div class="bottom">
        <div class="hint">妖精がなにか言っているよ</div>
        <button id="listen" class="cmd" type="button">聞いてみる</button>
      </div>
    </div>
  </div>
</section>

<!-- 画面3：遷移後（自由編集） -->
<section id="s3" class="screen">
  <div class="stage">
    <div class="frame">
      <div class="bottom">
        <div class="hint">観察ありがとう！ 次の謎へ進もう</div>
        <a id="nextLink" class="cmd" href="./">トップへ戻る</a>
      </div>
    </div>
  </div>
</section>

<!-- 音声（3つを順に再生：音声１ → 効果音 → 音声２） -->
<audio id="voice1" preload="auto">
  <source src="音声１.m4a" type="audio/mp4"/>
  <source src="音声1.m4a"  type="audio/mp4"/>
  <source src="voice1.m4a"  type="audio/mp4"/>
</audio>
<audio id="sfx" preload="auto">
  <source src="効果音.m4a" type="audio/mp4"/>
  <source src="sfx.m4a"   type="audio/mp4"/>
  <source src="効果音.mp3" type="audio/mpeg"/>
</audio>
<audio id="voice2" preload="auto">
  <source src="音声２.m4a" type="audio/mp4"/>
  <source src="音声2.m4a"  type="audio/mp4"/>
  <source src="voice2.m4a"  type="audio/mp4"/>
</audio>

<script>
(function(){
  // 画面切替
  const s1 = document.getElementById('s1');
  const s2 = document.getElementById('s2');
  const s3 = document.getElementById('s3');
  function show(el){ [s1,s2,s3].forEach(sec=>sec.classList.remove('show')); el.classList.add('show'); }

  // 画像読み込み（日本語/英字・assets/ 両対応フォールバック）
  function loadByCandidates(imgEl, list){
    let i=0; const go=()=>{ imgEl.onerror=()=>{ if(++i<list.length) go(); }; imgEl.src=list[i]; }; go();
  }
  loadByCandidates(
    document.getElementById('scope'),
    ["microscope.png","顕微鏡.png","microscope.jpg","顕微鏡.jpg","assets/microscope.png","assets/顕微鏡.png"]
  );
  loadByCandidates(
    document.getElementById('viewPic'),
    ["image1.png","画像１.png","画像1.png","image1.jpg","assets/image1.png","assets/画像１.png","assets/画像1.png"]
  );

  // 1→2
  document.getElementById('toView').addEventListener('click', ()=> show(s2));

  // 2→3：「聞いてみる」で 音声１→効果音→音声２ を順に再生。失敗はスキップ。最後で自動遷移。
  const v1 = document.getElementById('voice1');
  const se = document.getElementById('sfx');
  const v2 = document.getElementById('voice2');

  function playSeq(list, onAllDone){
    let i = 0, safetyTimer = null;
    const next = ()=>{
      if (i >= list.length){ clearTimeout(safetyTimer); return onAllDone(); }
      const a = list[i++];

      const advance = ()=>{ a.onended=null; a.onerror=null; next(); };
      a.onended = advance;
      a.onerror = advance;

      try{
        const p = a.play();
        // 再生開始できない／自動再生制限など → 即スキップ
        if (p && typeof p.then === 'function'){
          p.catch(advance);
        } else {
          // 古い環境は保険でスキップ
          setTimeout(advance, 6000);
        }
        // 無音/壊れたファイル保険：1秒で進捗なければスキップ
        const t0 = a.currentTime;
        setTimeout(()=>{ if (a.paused || a.currentTime===t0) advance(); }, 1000);
      }catch(e){ advance(); }
    };
    // 万一の総合保険：30秒で終了扱い
    safetyTimer = setTimeout(()=>onAllDone(), 30000);
    next();
  }

  document.getElementById('listen').addEventListener('click', ()=>{
    // 二度押し防止
    const btn = document.getElementById('listen');
    btn.disabled = true; btn.style.opacity = .7;

    playSeq([v1,se,v2], ()=>{ show(s3); });
  });

  // 3画面目リンク先（必要なら変更）
  document.getElementById('nextLink').href = "./";
})();
</script>
</body>
</html>
